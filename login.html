<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; object-src 'none'; frame-ancestors 'none'; base-uri 'self';">
    <title>Login â€” Secure Web</title>
    <link rel="stylesheet" href="style.css">
  </head>
  <body>
    <header>
      <h1>My Secure Web App</h1>
      <nav>
        <a href="index.html">Home</a>
      </nav>
    </header>
    <main>
      <div class="center-wrapper">
        <h2>Login</h2>
        <form id="loginForm" method="POST" action="#">
        <label>Email:</label>
        <input id="loginEmail" name="email" type="email" required>
        <label>Password:</label>
        <input id="loginPassword" name="password" type="password" required>
        <!-- Role selection removed: role is determined by the account stored in the database -->
        <button type="submit">Login</button>
        </form>
      </div>
      <p id="loginMessage" style="color:red"></p>
    </main>
    <script type="module">
    import { verifyCredentials, setSession, setSessionCookie, getUser, ensureSeeded, getLockInfo, recordFailedAttempt, resetFailedAttempts } from './users.js';

      // Ensure the demo admin account exists. This seeds a user in IndexedDB
      // if it isn't already present. Good for trying the admin flows.
      ensureSeeded();

      const form = document.getElementById('loginForm');
      const msg = document.getElementById('loginMessage');

      // When the user submits the login form it does the following:
      // Steps (easy summary):
      // 1) Prevent the normal form submission (we handle it in JS).
      // 2) Check if the email is currently locked due to failed attempts.
      // 3) Verify the email + password against the local database.
      // 4) If successful: clear failed attempts, set session marker, and
      //    redirect the user to the correct page based on role.
      // 5) If failed: record a failed attempt and show a helpful message.
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        msg.textContent = '';
        const email = document.getElementById('loginEmail').value.trim();
        const password = document.getElementById('loginPassword').value;
        try {
          // check lock status (simple client-side protection)
          const lock = getLockInfo(email);
          const now = Date.now();
          if (lock.lockedUntil && lock.lockedUntil > now) {
            const wait = Math.ceil((lock.lockedUntil - now) / 1000);
            msg.textContent = `Too many failed attempts. Try again in ${wait} seconds.`;
            return;
          }

          // verifyCredentials reads the stored user and compares the hash
          // of the provided password. This is all local to the browser.
          const ok = await verifyCredentials(email, password);
          if (!ok) {
            // recordFailedAttempt stores a small counter in localStorage
            // so repeated failures cause a temporary lockout.
            const next = recordFailedAttempt(email);
            const attemptsLeft = 3 - (next.count || 0);
            if (next.lockedUntil && next.lockedUntil > Date.now()) {
              const wait = Math.ceil((next.lockedUntil - Date.now()) / 1000);
              msg.textContent = `Account locked due to multiple failed attempts. Try again in ${wait} seconds.`;
            } else {
              msg.textContent = `Invalid credentials. ${attemptsLeft} attempt(s) left.`;
            }
            return;
          }

          // The credentials matched. Load the user record to check role.
          const user = await getUser(email);
          if (!user) {
            msg.textContent = 'User record not found.';
            return;
          }

          // Route by the stored account role (do not allow choosing a different role)
          const actualRole = user.role || 'user';

          // success: clear failed attempts and set session marker
          resetFailedAttempts(email);
          setSession(email);
          // setSessionCookie creates a demo cookie so other tabs can see the
          // login; note cookies set by JS are not HttpOnly (they are readable
          // by scripts) so this is a demo-only convenience.
          setSessionCookie(email, 3600);

          // Route by role
          if (actualRole === 'admin') {
            location.href = 'admin.html';
          } else {
            location.href = 'reservations.html';
          }
        } catch (err) {
          console.error(err);
          msg.textContent = 'Login failed';
        }
      });
    </script>
  </body>
</html>

