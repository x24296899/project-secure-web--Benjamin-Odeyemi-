<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; object-src 'none'; frame-ancestors 'none'; base-uri 'self';">
    <title>Admin Panel â€” Secure Web</title>
    <link rel="stylesheet" href="style.css">
  </head>
  <body>
    <header style="position:relative;">
      <h1>My Secure Web App</h1>
      <div id="profile" style="position:absolute; right:12px; top:12px;"></div>
      <nav>
        <a href="admin.html">Admin Panel</a> | <a href="admin-users.html">Users &amp; Reservations</a>
      </nav>
    </header>
    <main>
      <h2>Admin Panel</h2>
      <p id="welcome"></p>
      <button id="logoutBtn">Logout</button>
      <h3>Registered users</h3>
      <table id="usersTable" border="1" cellpadding="6">
        <thead>
          <tr><th>Email</th><th>Role</th><th>Created</th><th>Actions</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </main>
    <script type="module">
      import { getSession, clearSession, getAllUsers, deleteUser, getUser } from './users.js';

      const welcome = document.getElementById('welcome');
      const logoutBtn = document.getElementById('logoutBtn');
      const tbody = document.querySelector('#usersTable tbody');

      function formatDate(ts) {
        return new Date(ts).toLocaleString();
      }

      async function render() {
        const email = getSession();
        if (!email) {
          location.href = 'login.html';
          return;
        }
        const me = await getUser(email);
        if (!me || me.role !== 'admin') {
          location.href = 'login.html';
          return;
        }
    welcome.textContent = `Logged in as ${email} (admin)`;
    const profile = document.getElementById('profile');
      if (profile) {
        profile.textContent = '';
        const txt = document.createElement('span'); txt.textContent = 'Signed in as ';
        const strong = document.createElement('strong'); strong.textContent = email;
        const btn = document.createElement('button'); btn.id = 'logoutSmall'; btn.textContent = 'Logout';
        profile.appendChild(txt); profile.appendChild(strong); profile.appendChild(document.createTextNode(' ')); profile.appendChild(btn);
        btn.addEventListener('click', () => { clearSession(); location.href = 'index.html'; });
      }
        const users = await getAllUsers();
  tbody.textContent = '';
        users.forEach(u => {
          const tr = document.createElement('tr');
          const tdEmail = document.createElement('td'); tdEmail.textContent = u.email;
          const tdRole = document.createElement('td'); tdRole.textContent = u.role || '';
          const tdCreated = document.createElement('td'); tdCreated.textContent = formatDate(u.createdAt);
          const tdActions = document.createElement('td');
          // protect seeded admin and other admins from accidental deletion
          const isSeedAdmin = u.email === 'admin@example.com';
          const canDelete = !isSeedAdmin && (u.role !== 'admin');
          if (canDelete) {
            const btn = document.createElement('button'); btn.className = 'del'; btn.dataset.email = u.email; btn.textContent = 'Delete'; tdActions.appendChild(btn);
          } else {
            tdActions.appendChild(document.createTextNode(isSeedAdmin ? 'protected' : 'admin'));
          }
          tr.appendChild(tdEmail); tr.appendChild(tdRole); tr.appendChild(tdCreated); tr.appendChild(tdActions);
          tbody.appendChild(tr);
        });
        tbody.querySelectorAll('button.del').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            const email = e.currentTarget.dataset.email;
            if (!confirm(`Delete user ${email}?`)) return;
            await deleteUser(email);
            render();
          });
        });
      }

      logoutBtn.addEventListener('click', () => {
        clearSession();
        location.href = 'index.html';
      });

      render();
    </script>
  </body>
</html>
